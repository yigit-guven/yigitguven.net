<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>That Time I Generated a Grid on My Image</title>
    <link rel="icon" type="image/svg+xml" href="/images/projecticons/grid.svg">

    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

            // If user saved 'dark', or hasn't saved anything but prefers dark OS theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>

    <style>
        /* 1. Define Variables (Light Mode Default) */
        :root {
            --bg-color: #f0f0f0;
            --container-bg: #ffffff;
            --text-color: #333333;
            --border-color: #cccccc;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent-color: #007bff;
        }

        /* 2. Define Dark Mode Overrides */
        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --container-bg: #2d2d2d;
            --text-color: #e0e0e0;
            --border-color: #444444;
            --shadow: rgba(0, 0, 0, 0.5);
            --accent-color: #4da3ff;
        }

        /* 3. Global Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            /* Ensures footer stays at bottom */
            align-items: center;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: background 0.3s, color 0.3s;
        }

        /* Header */
        .header {
            width: 100%;
            max-width: 900px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        .header span {
            font-size: 0.9rem;
            opacity: 0.7;
        }

        /* Controls Area */
        .controls {
            background: var(--container-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        input,
        select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        /* Helper class to hide/show inputs without breaking UI style */
        .hidden {
            display: none !important;
        }

        /* Specific style for color picker */
        input[type="color"] {
            padding: 0;
            width: 50px;
            height: 40px;
            border: none;
            cursor: pointer;
            background: none;
        }

        button {
            padding: 10px 20px;
            background: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        button:hover {
            opacity: 0.9;
        }

        .theme-btn {
            background: transparent;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 15px;
        }

        /* Toggle button style */
        .toggle-btn {
            background: #6c757d;
            /* Grey color for toggle */
        }

        /* Back Button */
        .back-btn {
            text-decoration: none;
            color: var(--text-color);
            font-weight: bold;
            margin-right: 15px;
            display: flex;
            align-items: center;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .back-btn:hover {
            opacity: 1;
        }

        /* Canvas */
        canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow);
        }

        /* Footer */
        .footer {
            margin-top: auto;
            padding-top: 40px;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
            width: 100%;
            border-top: 1px solid var(--border-color);
            line-height: 1.6;
        }

        .footer a {
            color: var(--accent-color);
            text-decoration: none;
            margin: 0 5px;
        }

        .footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>

    <div class="header">
        <div style="display:flex; align-items:center;">
            <a href="/" class="back-btn">‚Üê Home</a>
            <div>
                <h1>That Time I Generated a Grid on My Image</h1>
                <span>Open Source Grid Generator</span>
            </div>
        </div>
        <button class="theme-btn" onclick="toggleTheme()">üåó Theme</button>
    </div>

    <div class="controls">
        <input type="file" id="upload" accept="image/*">

        <select id="gridMode" title="Calculation Mode">
            <option value="count">Count (Rows/Cols)</option>
            <option value="size">Size (Pixels)</option>
        </select>

        <span id="inputs-count" style="display: contents;">
            <input type="number" id="rows" placeholder="Rows" value="10" style="width: 80px;" title="Rows (Y)">
            <input type="number" id="cols" placeholder="Cols" value="10" style="width: 80px;" title="Cols (X)">
        </span>

        <span id="inputs-size" class="hidden" style="display: contents;">
            <input type="number" id="cellSize" placeholder="Px Size" value="32" step="0.1" style="width: 80px;"
                title="Cell Size (px)">
        </span>

        <input type="number" id="lineWidth" placeholder="Width" value="1" min="0.1" step="0.1" style="width: 80px;"
            title="Line Width (px)">

        <input type="color" id="gridColor" value="#ff0000" title="Grid Color">

        <button onclick="drawGrid()">Update Grid</button>
        <button id="toggleBtn" class="toggle-btn" onclick="toggleGrid()">Hide Grid</button>

        <button onclick="downloadImage()" style="background: #28a745;">Download Image</button>
    </div>

    <canvas id="canvas"></canvas>

    <div class="footer">
        <p>
            Developed by <a href="https://github.com/yigit-guven" target="_blank">Yigit Guven</a><br>
            Licensed by <a
                href="https://github.com/yigit-guven/That-Time-I-Generated-a-Grid-on-My-Image/blob/main/LICENSE"
                target="_blank">MIT License</a>
        </p>
        <p>
            <a href="https://github.com/yigit-guven/That-Time-I-Generated-a-Grid-on-My-Image" target="_blank">GitHub
                Repo</a> |
            <a href="https://github.com/yigit-guven/That-Time-I-Generated-a-Grid-on-My-Image/blob/main/SECURITY.md"
                target="_blank">Privacy & Security</a>
        </p>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const toggleBtn = document.getElementById('toggleBtn');
        const modeSelect = document.getElementById('gridMode');

        let currentImg = null;
        let isGridVisible = true; // Track grid state

        // 1. Handle Image Upload
        document.getElementById('upload').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (event) {
                const img = new Image();
                img.onload = function () {
                    currentImg = img;
                    drawGrid();
                }
                img.src = event.target.result;
            }
            reader.readAsDataURL(file);
        });

        // 1.5 Auto-update when inputs change
        const inputs = ['gridColor', 'lineWidth', 'rows', 'cols', 'cellSize'];
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', drawGrid);
        });

        // 2. Handle Mode Switching (UI Logic)
        modeSelect.addEventListener('change', function () {
            const mode = this.value;
            const countInputs = document.getElementById('inputs-count');
            const sizeInputs = document.getElementById('inputs-size');

            if (mode === 'count') {
                countInputs.classList.remove('hidden');
                sizeInputs.classList.add('hidden');
            } else {
                countInputs.classList.add('hidden');
                sizeInputs.classList.remove('hidden');
            }
            drawGrid();
        });

        // 3. Toggle Logic
        function toggleGrid() {
            if (!currentImg) return;

            isGridVisible = !isGridVisible;

            // Update button text
            if (isGridVisible) {
                toggleBtn.innerText = "Hide Grid";
                toggleBtn.style.opacity = "1";
            } else {
                toggleBtn.innerText = "Show Grid";
                toggleBtn.style.opacity = "0.7";
            }

            drawGrid();
        }

        // 4. Draw Grid Logic
        function drawGrid() {
            if (!currentImg) return;

            // Resize canvas to match the image size
            canvas.width = currentImg.width;
            canvas.height = currentImg.height;

            // Draw the original image first
            ctx.drawImage(currentImg, 0, 0);

            // Only draw lines if grid is visible
            if (isGridVisible) {
                const widthVal = parseFloat(document.getElementById('lineWidth').value) || 1;
                const color = document.getElementById('gridColor').value;
                const mode = modeSelect.value;

                ctx.strokeStyle = color;
                ctx.lineWidth = widthVal;

                // Determine Step Sizes
                let stepX, stepY;

                if (mode === 'count') {
                    // Logic: Total Rows/Cols
                    const rows = parseInt(document.getElementById('rows').value) || 10;
                    const cols = parseInt(document.getElementById('cols').value) || 10;
                    stepX = canvas.width / cols;
                    stepY = canvas.height / rows;
                } else {
                    // Logic: Pixel Size
                    const size = parseFloat(document.getElementById('cellSize').value) || 32;
                    stepX = size;
                    stepY = size;
                }

                // Draw Horizontal Lines
                for (let y = stepY; y < canvas.height; y += stepY) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }

                // Draw Vertical Lines
                for (let x = stepX; x < canvas.width; x += stepX) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
            }
        }

        // 5. Download Logic
        function downloadImage() {
            if (!currentImg) return alert("Please upload an image first!");

            const link = document.createElement('a');
            link.download = isGridVisible ? 'grid-generated-image.png' : 'clean-image.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // 6. Theme Logic (Persistent)
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');

            if (currentTheme === 'dark') {
                html.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            }
        }
    </script>
</body>

</html>